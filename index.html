<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Generic Lambdas in C++ using Clang by faisalv</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Generic Lambdas in C++ using Clang</h1>
        <p>An Implementation of generic (polymorphic) lambdas using clang (llvm version 167560 [11/7/12]); based on C++ Portland October 2012 meeting</p>

        <p class="view"><a href="https://github.com/faisalv/clang-glambda">View the Project on GitHub <small>faisalv/clang-glambda</small></a></p>


        <ul>
          <li><a href="https://github.com/faisalv/clang-glambda/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/faisalv/clang-glambda/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/faisalv/clang-glambda">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>Generic Lambdas in C++ using Clang</h1>

<h2>This is a Toy implementation of Generic Lambdas for C++ based on the <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2012/n3418.pdf">n3418: Proposal for Generic Lambda Expressions</a>.</h2>

<h3>This is NOT by any means intended to be a production ready implementation, and almost certainly has bugs that either I have not yet discovered, or bugs that have been reported (thank you in advance for making the effort to do so) and which I am currently working on.</h3>

<h3>This implementation's raison d'Ãªtre is to encourage developers to play with the generic lambda feature and provide bug reports and feedback to us.  We hope that this will prove useful to the C++ community and help guide us as we work on the next version of our proposal for the C++ Standardization meeting to be held in Bristol (April 2013).</h3>

<h3>The current version (12/2012) implements subproposals 2.1, 2.2, 2.3 and 2.5.</h3>

<h3>2.1 Allow the type-specifier within a parameter declaration of a lambda to be auto (i.e. auto is mandatory)</h3>

<pre><code>auto Sum = [](auto a, decltype(a) b) { return a + b; };
int i = Sum(3, 4);
double d = Sum(3.14, 2.77);
</code></pre>

<h3>2.2 Allow the use of familiar template syntax in lambda expressions</h3>

<pre><code>auto NumElements = []&lt;int N&gt;(auto (&amp;a)[N]) { return N; }; 
int arri[]{1, 2, 3};
double arrd[]{3.14, 2.77, 6.626};
auto total = NumElements(arri) + NumElements(arrd);
</code></pre>

<h3>2.3 Permit a lambda body to be an expression</h3>

<pre><code>int local = 10;
auto L = [&amp;](auto a) a + ++local;
</code></pre>

<h3>2.4 Named Lambda Syntax has NOT been implemented yet</h3>

<h3>2.5 Autogenerate a conversion to function pointer in captureless generic lambdas</h3>

<pre><code>auto L = [](auto a, decltype(a) b) { return a + b; };
int (*fp)(int, int) = L;
</code></pre>

<h3>I also used Richard Smith's (<a href="https://github.com/zygoloid" class="user-mention">@zygoloid</a>) return type deduction patch to allow the following</h3>

<pre><code>int local = 10;
auto L = [](auto &amp;a) -&gt; auto&amp; { return a; };
++L(local); 
</code></pre>

<h2>How to Compile the Code on Windows</h2>

<ol>
<li>Checkout the appropriate version of llvm (167560) by following the instructions at : <a href="http://clang.llvm.org/get_started.html">http://clang.llvm.org/get_started.html</a>.  I use TortoiseSVN on windows. Be sure to download the correct version of llvm (167560) (use the -r option on command line).  Do NOT checkout anything else (i.e compiler-RT etc.) except for the correct revision of the llvm snapshot.</li>
<li>In the above instructions from the clang website, where it states to checkout clang using subversion (i.e step 3 svn co <a href="http://llvm.org/svn/llvm-project/cfe/trunk">http://llvm.org/svn/llvm-project/cfe/trunk</a> clang), instead install git (I use TortoiseGit on windows) and clone this repository into the subdirectory clang. For e.g, using the command line when in your-dir/llvm/tools/ try:
<pre>
git clone git:/github.com/faisalv/clang-glambda.git clang
</pre>
</li>
<li>Then follow the instructions as delineated on clangs website to compile and build clang.</li>
<li>Keep in mind that all the development has been done using Visual Studio 2010.</li>
<li>Once you have your clang binary, it should be able to compile your code, but on windows, I find myself having to use the interpreter lli.exe to actually execute my clang "compiled" code.  So I do the following when trying to compile code in test.cpp:
<pre>
clang -std=c++1y -c test.cpp -emit-llvm -o test.bc
lli test.bc
</pre>
</li>
</ol><h2>How to use the Windows binaries:</h2>

<ol>
<li>I have uploaded my most recent Debug build of generic-lambda-clang that was built using visual studio 2010.</li>
<li>In order for you to use it, you need certain debug dlls that I can not legally post here - An easy way is probably for you to install <a href="http://www.microsoft.com/visualstudio/eng/downloads#d-express-windows-desktop">Visual C++ 2010 Express (free)</a>.</li>
<li>Download the windows executable <a href="https://www.sugarsync.com/pf/D6969703_69613999_6754006">generic-lambda-clang.exe</a> along with the <a href="https://www.sugarsync.com/pf/D6969703_65299173_039062">llvm interpreter: lli.exe</a> if you need it.
<pre>
generic-lambda-clang -std=c++1y -c test.cpp -emit-llvm -o test.bc
lli test.bc
</pre>
</li>
<li>FYI: lli does cause bugs with executing the following code:  (This appears to be a bug with lli.exe and last I checked also occurred with the actual clang snapshot and has nothing to do with my changes).  The bug does not occur if you are on a platform that can compile the code natively.
<pre>
template &lt; class F1, class F2&gt;
struct overload : F1, F2 {
overload(F1 const&amp; f1, F2 const&amp; f2)
: F1(f1), F2(f2) { }
using F1::operator();
using F2::operator();
};
template &lt;class F1, class F2&gt;
overload &lt;F1, F2&gt; make_overload(F1 const&amp; f1, F2 const&amp; f2) {
return overload &lt;F1, F2&gt;(f1, f2);
}
int main() {
auto f1 = <a href="int%20i">&amp;</a> { return i; }; 
auto f2 = <a href="...">&amp;</a> { return 0; };
auto f = make_overload(f1, f2);
printf("%d\n", f(5));
printf("%d\n", f(3.14));
}
</pre>
</li>
</ol><h2>How to Compile the code on MacOS Lion</h2>

<ol>
<li>Download and install <a href="https://developer.apple.com/xcode/">XCode</a>
</li>
<li>Checkout the appropriate version of llvm (167560) by following the instructions at <a href="http://clang.llvm.org/get_started.html">Clang's Website</a>. Try this:
<pre>
svn co <a href="http://llvm.org/svn/llvm-project/llvm/trunk">http://llvm.org/svn/llvm-project/llvm/trunk</a> llvm -r 167560
</pre>
Do NOT checkout anything else (i.e compiler-RT etc.) except for the correct revision of the llvm snapshot.</li>
<li>In the above instructions from the clang website, where it states to checkout clang using subversion (i.e step 3 svn co <a href="http://llvm.org/svn/llvm-project/cfe/trunk">http://llvm.org/svn/llvm-project/cfe/trunk</a> clang), instead install git and clone this repository into the subdirectory clang. For e.g, using the command line when in your-dir/llvm/tools/ try:
<pre>
git clone git:/github.com/faisalv/clang-glambda.git clang
</pre>
</li>
<li>Then follow the instructions as delineated on clangs website to compile and build clang.</li>
<li>Once you have your clang binary, it should be able to compile your code into an executable. The binary typically gets dumped in build/Debug&amp;Asserts/bin/.
<pre>
./clang -std=c++1y test.cpp
./a.out
</pre>
</li>
<li>Please let me know if you encounter any bugs with any part of the process.</li>
</ol><h2>How to use the MacOS Lion Binaries</h2>

<ol>
<li>Download <a href="https://www.sugarsync.com/pf/D6969703_4922085_6704356">generic-lambda-clang-lion</a>
</li>
<li>Try the following:
<pre>
./generic-lambda-clang-lion test.cpp -std=c++1y
./a.out
</pre>
</li>
<li>Please Let me know if it works for you (I have been unable to test it on a non-development box)</li>
</ol>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/faisalv">faisalv</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>